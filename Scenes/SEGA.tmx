<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sonic Galactic - OpenGL 3 Emulator</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { 
            width: 848px; height: 480px; /* Escala 2x */
            image-rendering: pixelated;
            background: #000;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <script type="module">
        const canvas = document.getElementById('gameCanvas');
        const gl = canvas.getContext('webgl2');

        // 1. CÓDIGO DOS SHADERS (Localizados na pasta /Shaders)
        const vsSource = `
            attribute vec3 i_position;
            attribute vec2 i_uv;
            varying vec2 o_uv;
            uniform mat4 u_projectionMatrix;
            uniform mat4 u_modelViewMatrix;
            void main() {
                gl_Position = u_projectionMatrix * u_modelViewMatrix * vec4(i_position, 1.0);
                o_uv = i_uv;
            }
        `; //

        const fsSource = `
            precision mediump float;
            varying vec2 o_uv;
            uniform vec4 u_color;
            uniform sampler2D u_texture;
            uniform vec2 u_textureSize;
            uniform vec2 u_directionVector;
            void main() {
                vec2 offset = 1.0 / u_textureSize * u_directionVector;
                vec4 col_r = texture2D(u_texture, o_uv - offset);
                vec4 col_g = texture2D(u_texture, o_uv);
                vec4 col_b = texture2D(u_texture, o_uv + offset);
                vec4 color = vec4(col_r.r, col_g.g, col_b.b, col_g.a);
                gl_FragColor = color * u_color;
            }
        `; //

        // 2. CONFIGURAÇÃO BASEADA NO XML
        const config = {
            width: 424,
            height: 240,
            states: { DISCLAIMER: 0, STARTEAM: 1, SEGA: 2, TITLE: 3 }
        };

        canvas.width = config.width;
        canvas.height = config.height;

        // 3. MAPEAMENTO DE SPRITES LOCAIS
        // Substituindo links externos pelos arquivos dentro da sua pasta Sprites
        const assets = {
            [config.states.DISCLAIMER]: "Sprites/Startup/Disclaimer.png",
            [config.states.STARTEAM]:   "Sprites/Startup/Starteam.png",
            [config.states.SEGA]:       "Sprites/Startup/SEGA.png",
            [config.states.TITLE]:      "Sprites/TitleScreen/TitleBackground.png"
        };

        // --- LÓGICA DE INICIALIZAÇÃO WEBGL ---
        function createShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            return shader;
        }

        const program = gl.createProgram();
        gl.attachShader(program, createShader(gl, gl.VERTEX_SHADER, vsSource));
        gl.attachShader(program, createShader(gl, gl.FRAGMENT_SHADER, fsSource));
        gl.linkProgram(program);
        gl.useProgram(program);

        const positionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,1, 1,1, -1,-1, 1,-1]), gl.STATIC_DRAW);

        const texCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, texCoordBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([0,0, 1,0, 0,1, 1,1]), gl.STATIC_DRAW);

        const texture = gl.createTexture();
        let currentState = config.states.DISCLAIMER;
        let timer = 0;

        function updateTexture(img) {
            gl.bindTexture(gl.TEXTURE_2D, texture);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        }

        function render() {
            timer++;
            
            // Transições de estados (Tempo em frames)
            if (currentState === config.states.DISCLAIMER && timer > 120) { currentState = config.states.STARTEAM; timer = 0; }
            else if (currentState === config.states.STARTEAM && timer > 120) { currentState = config.states.SEGA; timer = 0; }
            else if (currentState === config.states.SEGA && timer > 120) { currentState = config.states.TITLE; timer = 0; }

            const img = new Image();
            img.src = assets[currentState];
            img.onload = () => updateTexture(img);

            gl.viewport(0, 0, config.width, config.height);
            gl.clear(gl.COLOR_BUFFER_BIT);

            // Configuração dos Uniforms do Shader
            const uLocSize = gl.getUniformLocation(program, "u_textureSize");
            const uLocDir = gl.getUniformLocation(program, "u_directionVector");
            const uLocCol = gl.getUniformLocation(program, "u_color");
            const uLocProj = gl.getUniformLocation(program, "u_projectionMatrix");
            const uLocMV = gl.getUniformLocation(program, "u_modelViewMatrix");

            gl.uniform2f(uLocSize, config.width, config.height);
            // Aplica efeito cromático suave apenas na logo SEGA e Título
            gl.uniform2f(uLocDir, currentState >= config.states.SEGA ? 1.2 : 0.0, 0.0);
            gl.uniform4f(uLocCol, 1.0, 1.0, 1.0, 1.0);
            
            const identity = new Float32Array([1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1]);
            gl.uniformMatrix4fv(uLocProj, false, identity);
            gl.uniformMatrix4fv(uLocMV, false, identity);

            const posLoc = gl.getAttribLocation(program, "i_position");
            gl.enableVertexAttribArray(posLoc);
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);

            const texLoc = gl.getAttribLocation(program, "i_uv");
            gl.enableVertexAttribArray(texLoc);
            gl.bindBuffer(gl.ARRAY_BUFFER, texCoordBuffer);
            gl.vertexAttribPointer(texLoc, 2, gl.FLOAT, false, 0, 0);

            gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
            requestAnimationFrame(render);
        }

        render();

        window.addEventListener('keydown', (e) => {
            if (e.key === 'F4') canvas.requestFullscreen(); //
        });
    </script>
</body>
</html>